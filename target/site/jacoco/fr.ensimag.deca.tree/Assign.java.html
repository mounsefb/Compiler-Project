<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Assign.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Deca Compiler</a> &gt; <a href="index.source.html" class="el_package">fr.ensimag.deca.tree</a> &gt; <span class="el_source">Assign.java</span></div><h1>Assign.java</h1><pre class="source lang-java linenums">package fr.ensimag.deca.tree;

import fr.ensimag.deca.context.Type;
import fr.ensimag.deca.tools.DecacInternalError;
import fr.ensimag.ima.pseudocode.Register;
import fr.ensimag.ima.pseudocode.RegisterOffset;
import fr.ensimag.ima.pseudocode.instructions.LOAD;
import fr.ensimag.ima.pseudocode.instructions.STORE;
import fr.ensimag.deca.DecacCompiler;
import fr.ensimag.deca.context.ClassDefinition;
import fr.ensimag.deca.context.ContextualError;
import fr.ensimag.deca.context.EnvironmentExp;

/**
 * Assignment, i.e. lvalue = expr.
 *
 * @author gl01
 * @date 01/01/2024
 */
public class Assign extends AbstractBinaryExpr {

    @Override
    public AbstractLValue getLeftOperand() {
        // The cast succeeds by construction, as the leftOperand has been set
        // as an AbstractLValue by the constructor.
<span class="fc" id="L26">        return (AbstractLValue)super.getLeftOperand();</span>
    }

    public Assign(AbstractLValue leftOperand, AbstractExpr rightOperand) {
<span class="fc" id="L30">        super(leftOperand, rightOperand);</span>
<span class="fc" id="L31">    }</span>

    @Override
    public Type verifyExpr(DecacCompiler compiler, EnvironmentExp localEnv, ClassDefinition currentClass) throws ContextualError {

            //Je verifie l'expression gauche du assign et recupere son type
<span class="fc" id="L37">            Type leftType = this.getLeftOperand().verifyExpr(compiler, localEnv, currentClass);</span>
            
            //Je verifie l'expression Ã  droite du assign et je le modifie en cas de convFloat
<span class="fc" id="L40">            this.setRightOperand(getRightOperand().verifyRValue(compiler, localEnv, currentClass, leftType));</span>
            //Type rightType = this.getRightOperand().verifyExpr(compiler, localEnv, currentClass);
            
            //Je decore mon arbre avec le type expected qui est celui de gauche
<span class="fc" id="L44">            this.setType(leftType);</span>

            //if(!compiler.environmentType.assignCompatible(leftType, rightType))throw new ContextualError(&quot;TypeMismatchException: Unable to assign two expressions of different types. Ensure that the types match or perform a type conversion if necessary. &quot;, getLocation());
            /* 
            else if(leftType.isFloat() &amp;&amp;  rightType.isInt()){
                this.setRightOperand((new ConvFloat(getRightOperand()))); 
                getRightOperand().verifyExpr( compiler,localEnv,  currentClass);
                this.setType(leftType);
                return leftType;
            }*/

            /*else if(leftType.sameType(rightType) ){
                this.setType(rightType);
                return rightType;
            }*/
            
            //Je le retourne
<span class="fc" id="L61">            return leftType;</span>
            
            
            
    }


    @Override
    protected String getOperatorName() {
<span class="nc" id="L70">        return &quot;=&quot;;</span>
    }

    @Override
    protected void codeGenInst(DecacCompiler compiler) {
<span class="nc" id="L75">        getRightOperand().codeGenInst(compiler);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (getRightOperand() instanceof MethodCall){ // added last</span>
<span class="nc" id="L77">            compiler.addInstruction(new LOAD(Register.R0, Register.getR(compiler.getHandleMemory().registreToUse())));</span>
        }
        try {
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if(getLeftOperand() instanceof Selection){</span>
<span class="nc" id="L81">                AbstractIdentifier ident =((Selection) getLeftOperand()).getIdent();</span>
<span class="nc" id="L82">                ((Selection)getLeftOperand()).codeGenInstasssign(compiler, true);</span>
<span class="nc" id="L83">                compiler.addInstruction(new STORE(Register.getR(compiler.getHandleMemory().getfull()-1), new RegisterOffset(ident.getFieldDefinition().getIndex(), Register.getR(compiler.getHandleMemory().getfull()))));</span>
<span class="nc" id="L84">                compiler.getHandleMemory().registerLiberate();</span>

<span class="nc" id="L86">            } else{</span>
<span class="nc" id="L87">                Identifier ident = (Identifier) getLeftOperand();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (ident.getDefinition().isField()){</span>
<span class="nc" id="L89">                    compiler.addInstruction(new LOAD(new RegisterOffset(-2, Register.LB), Register.R0));</span>
<span class="nc" id="L90">                    compiler.addInstruction(new STORE(Register.getR(compiler.getHandleMemory().getfull()),new RegisterOffset(ident.getFieldDefinition().getIndex(), Register.R0)));</span>
<span class="nc" id="L91">                } else {</span>
<span class="nc" id="L92">                    compiler.addInstruction(new STORE(Register.getR(compiler.getHandleMemory().getfull()), ident.getExpDefinition().getOperand()));</span>
                }
            }
<span class="nc" id="L95">            compiler.getHandleMemory().registerLiberate();</span>




<span class="nc" id="L100">        } catch (ClassCastException e) {</span>
<span class="nc" id="L101">            throw new DecacInternalError(</span>
<span class="nc" id="L102">                    &quot;left Operand &quot;</span>
<span class="nc" id="L103">                            + getLeftOperand()</span>
<span class="nc" id="L104">                            + &quot; is not a identifier, you can't call getExpDefinition on it&quot;);</span>
        }
<span class="nc" id="L106">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>